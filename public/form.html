<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Blinkshop — Create Drop</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    @font-face {
      font-family: 'Inter';
      src: url('/fonts/inter/InterVariable.ttf') format('truetype');
      font-weight: 100 900;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "SF Pro", "San Francisco", "Helvetica Neue", Helvetica, Arial, sans-serif;
      --font-size-label: 1.5rem;
      --font-size-sublabel: 0.75rem;
      --font-size-input: 1rem;
      --border-radius: 0.75rem;
      --pill-radius: 999px;
      --pill-border: 1px solid #ccc;
      --pill-padding: 0.6rem 0.75rem;
    }

    :root[data-theme="minimal"] {
      --bg: #ffffff;
      --text: #111111;
      --sublabel-text: #666666;
      --input-bg: #f9f9f9;
      --input-border: #dddddd;
      --placeholder: #aaaaaa;
      --pill-bg: #222222;
      --pill-text: #ffffff;
      --rail-bg: #e0e0e0;
      --image-bg: #eeeeee;
    }

    :root[data-theme="dark"] {
      --bg: #111111;
      --text: #ffffff;
      --sublabel-text: #aaaaaa;
      --input-bg: #222222;
      --input-border: #444444;
      --placeholder: #888888;
      --pill-bg: #ffffff;
      --pill-text: #111111;
      --rail-bg: #333333;
      --image-bg: #333333;
    }

    :root[data-theme="warm"] {
      --bg: #fff8f1;
      --text: #442000;
      --sublabel-text: #aa7755;
      --input-bg: #fff2e5;
      --input-border: #e0c2a0;
      --placeholder: #bb8855;
      --pill-bg: #c16626;
      --pill-text: #ffffff;
      --rail-bg: #f1d6be;
      --image-bg: #f3e2d5;
    }

    body {
      font-family: var(--font-sans);
      margin: 0;
      padding: 2rem 1rem;
      background: var(--bg);
      color: var(--text);
      transition: background 0.4s ease, color 0.4s ease;
    }

    * {
      box-sizing: border-box;
    }

    /* Auth section styles */
    .auth-section {
      max-width: 400px;
      margin: 0 auto;
      text-align: center;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .auth-section h1 {
      font-size: var(--font-size-label);
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .auth-section p {
      color: var(--sublabel-text);
      margin-bottom: 1rem;
      font-size: var(--font-size-input);
      line-height: 1.4;
    }

    #auth-email {
      width: 100%;
      font-size: var(--font-size-input);
      padding: 0.6rem 1rem;
      border: 1px solid var(--input-border);
      border-radius: var(--border-radius);
      font-family: inherit;
      background: var(--input-bg);
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    #auth-email::placeholder {
      color: var(--placeholder);
      font-size: 0.85rem;
    }

    #send-magic-link {
      background: var(--pill-bg);
      color: var(--pill-text);
      border: none;
      padding: 1rem 2rem;
      border-radius: var(--pill-radius);
      cursor: pointer;
      font-size: var(--font-size-input);
      font-weight: 500;
      width: 100%;
      transition: opacity 0.2s;
      font-family: inherit;
    }

    #send-magic-link:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #magic-link-sent {
      display: none;
      margin-top: 0.5rem;
      color: var(--sublabel-text);
      font-size: var(--font-size-sublabel);
      padding: 0.75rem;
      background: var(--input-bg);
      border-radius: var(--border-radius);
      border: 1px solid var(--input-border);
    }

    .user-info {
      display: none;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background: var(--input-bg);
      border-radius: var(--border-radius);
      font-size: var(--font-size-sublabel);
    }

    .sign-out-btn {
      background: none;
      border: 1px solid var(--input-border);
      padding: 0.25rem 0.5rem;
      border-radius: var(--border-radius);
      font-size: var(--font-size-sublabel);
      cursor: pointer;
      color: var(--text);
    }

    .drop-container {
      max-width: 400px;
      margin: 0 auto;
      display: none;
      flex-direction: column;
      gap: 0.8rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: var(--font-size-label);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .sublabel {
      font-size: var(--font-size-sublabel);
      color: var(--sublabel-text);
      margin-top: -0.5rem;
      margin-bottom: 0.5rem;
      line-height: 1.3;
    }

    .char-count {
      font-size: var(--font-size-sublabel);
      text-align: right;
      color: var(--sublabel-text);
      margin-top: 0.25rem;
    }

    .footer-whisper {
      font-size: 0.75rem;
      color: var(--sublabel-text);
      text-align: center;
      margin-top: 1rem;
      opacity: 0.6;
      font-style: italic;
    }

    input,
    textarea,
    select {
      width: 100%;
      font-size: var(--font-size-input);
      padding: 0.6rem 1rem;
      border: 1px solid var(--input-border);
      border-radius: var(--border-radius);
      font-family: inherit;
      background: var(--input-bg);
      color: var(--text);
    }

    input[type="file"] {
      padding: 0.5rem;
      background: var(--input-bg);
      border: 2px dashed var(--input-border);
      cursor: pointer;
    }

    textarea {
      resize: none;
      min-height: 100px;
      line-height: 1.4;
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--placeholder);
      font-size: 0.85rem;
    }

    .row {
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
    }

    .row > div {
      min-width: 0;
    }

    .row.triple > .title-block {
      flex: 1.3;
    }

    .row.triple > div:nth-child(2),
    .row.triple > div:nth-child(3) {
      flex: 0.5;
    }

    .theme-selector {
      position: relative;
      width: 100%;
      height: 2.5rem;
      background: var(--rail-bg);
      border-radius: var(--pill-radius);
      margin-bottom: 1rem;
    }

    .theme-labels {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2;
      pointer-events: none;
    }

    .theme-labels span {
      flex: 1;
      text-align: center;
      font-size: 0.85rem;
      font-weight: 500;
      pointer-events: auto;
      cursor: pointer;
      background: none !important;
      color: var(--text);
    }

    .theme-labels span[data-active] {
      color: var(--pill-text);
      font-weight: 600;
    }

    [data-theme="minimal"] .theme-pill {
      transform: translateX(0%);
    }

    [data-theme="dark"] .theme-pill {
      transform: translateX(100%);
    }

    [data-theme="warm"] .theme-pill {
      transform: translateX(200%);
    }

    .theme-pill {
      position: absolute;
      top: 0;
      width: 33.3333%;
      height: 100%;
      border-radius: var(--pill-radius);
      transition: transform 0.3s ease, background 0.3s ease;
      z-index: 1;
      background: var(--pill-bg);
    }

    .price-input-wrapper {
      position: relative;
    }

    .price-input-wrapper input {
      padding-left: 1.5rem;
    }

    .price-icon {
      position: absolute;
      left: 0.6rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      color: var(--placeholder);
      pointer-events: none;
    }

    .preview-image {
      width: 100%;
      height: auto;
      max-height: 200px;
      border-radius: 1rem;
      object-fit: cover;
      background: var(--image-bg);
      margin-top: 0.5rem;
      display: block;
    }

    .upload-status {
      font-size: var(--font-size-sublabel);
      color: var(--sublabel-text);
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: var(--input-bg);
      border-radius: var(--border-radius);
      text-align: center;
    }

    button.publish {
      border: none;
      padding: 1rem;
      font-size: 1rem;
      border-radius: var(--pill-radius);
      width: 150px;
      cursor: pointer;
      background: var(--pill-bg);
      color: var(--pill-text);
      margin-left: auto;
      margin-right: auto;
      display: block;
      margin-top: 1.5rem;
      transition: background 0.3s ease, color 0.3s ease;
    }

    button.publish:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <!-- Authentication Section -->
  <div id="auth-section" class="auth-section">
    <h1>Welcome to BlinkShop</h1>
    <p>Create beautiful, shoppable product pages from your camera roll in seconds</p>
    <input type="email" id="auth-email" placeholder="Enter your email">
    <button id="send-magic-link">Send Magic Link</button>
    <div id="magic-link-sent">Magic link sent! Check your email.</div>
  </div>

  <!-- Your Original Form -->
  <div class="drop-container" id="drop-container">
    <!-- User info bar -->
    <div id="user-info" class="user-info">
      <span id="user-email"></span>
      <button id="sign-out" class="sign-out-btn">Sign Out</button>
    </div>

    <div class="form-group">
      <label for="imageInput">Product Image</label>
      <div class="sublabel">Upload a photo of your product</div>
      <input type="file" id="imageInput" accept="image/*">
      <div id="upload-status" class="upload-status" style="display: none;">Uploading image...</div>
      <img id="image-preview" class="preview-image" src="https://via.placeholder.com/400x300" alt="Preview">
    </div>

    <div class="form-group">
      <label>Vibe</label>
      <div class="sublabel">Pick a vibe for your drop</div>
      <div class="theme-selector">
        <div class="theme-pill"></div>
        <div class="theme-labels">
          <span data-theme-value="minimal" data-active="">Minimal</span>
          <span data-theme-value="dark">Dark</span>
          <span data-theme-value="warm">Warm</span>
        </div>
      </div>
    </div>

    <div class="row triple">
      <div class="title-block">
        <label>Product title</label>
        <div class="sublabel">Name your masterpiece</div>
        <input type="text" id="titleInput" placeholder="E.g. Strawberry lip balm">
      </div>
      <div>
        <label>Qty</label>
        <div class="sublabel">How many?</div>
        <input type="number" id="qtyInput" placeholder="0" min="1" value="1">
      </div>
      <div>
        <label>Price</label>
        <div class="sublabel">Name it</div>
        <div class="price-input-wrapper">
          <input type="number" id="priceInput" placeholder="0.00" min="1" step="0.01">
          <span class="price-icon">$</span>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Story</label>
      <div class="sublabel">Say something about it</div>
      <textarea id="storyInput" maxlength="300" placeholder="What inspired this? How long have you been doing this for? How did it start?
How do you recommend using it?
Any additional details?"></textarea>
      <div class="char-count" id="storyCount">0 / 300</div>
    </div>

    <div class="row">
      <div>
        <label>Shipping policy</label>
        <div class="sublabel">How quickly can you ship?</div>
        <select id="shippingInput">
          <option value="1-2 days">1-2 business days</option>
          <option value="3-5 days">3-5 business days</option>
          <option value="1 week">1 week</option>
          <option value="2+ weeks">2+ weeks (made to order)</option>
        </select>
      </div>
      <div>
        <label>Returns policy</label>
        <div class="sublabel">What's your approach to returns?</div>
        <select id="returnsInput">
          <option value="contact">Contact seller to discuss</option>
          <option value="7-day">7-day return window</option>
          <option value="final-sale">No returns (final sale)</option>
        </select>
      </div>
    </div>

    <button class="publish" id="publish-btn">Publish</button>

    <div class="footer-whisper">Powered by<br><strong>Blink.shop</strong></div>
  </div>

  <script>
    // Initialize theme immediately for auth section styling
    document.documentElement.setAttribute('data-theme', 'minimal');

    // Initialize Supabase
    const supabase = window.supabase.createClient(
      'https://zvlfqyfzenoywrxzovzt.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2bGZxeWZ6ZW5veXdyeHpvdnp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyODg1MTUsImV4cCI6MjA2Nzg2NDUxNX0.rLs1HCUuBk7DPEA3w3t-52MA0Esh1u4spXX-1Y5y5HU'
    );

    // Auth elements
    const authSection = document.getElementById('auth-section');
    const dropContainer = document.getElementById('drop-container');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const authEmailInput = document.getElementById('auth-email');
    const sendMagicLinkBtn = document.getElementById('send-magic-link');
    const magicLinkSent = document.getElementById('magic-link-sent');
    const signOutBtn = document.getElementById('sign-out');

    // Form elements
    const themeLabels = document.querySelectorAll('.theme-labels span');
    const storyInput = document.getElementById('storyInput');
    const storyCount = document.getElementById('storyCount');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('image-preview');
    const uploadStatus = document.getElementById('upload-status');
    const publishBtn = document.getElementById('publish-btn');

    // Auth state management
    let currentUser = null;
    let currentTheme = 'minimal';
    let uploadedImageUrl = null;

    // Check auth on load
    checkAuthState();

    async function checkAuthState() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        currentUser = session.user;
        showForm();
      } else {
        showAuth();
      }
    }

    function showAuth() {
      authSection.style.display = 'block';
      dropContainer.style.display = 'none';
    }

    function showForm() {
      authSection.style.display = 'none';
      dropContainer.style.display = 'flex';
      userInfo.style.display = 'flex';
      userEmail.textContent = currentUser?.email || '';
    }

    // Magic link handler
    sendMagicLinkBtn.addEventListener('click', async () => {
      const email = authEmailInput.value.trim();
      if (!email) return;

      sendMagicLinkBtn.disabled = true;
      sendMagicLinkBtn.textContent = 'Sending...';

      const { error } = await supabase.auth.signInWithOtp({
        email: email,
        options: { emailRedirectTo: window.location.href }
      });

      if (!error) {
        magicLinkSent.style.display = 'block';
        sendMagicLinkBtn.textContent = 'Link Sent!';
      } else {
        sendMagicLinkBtn.disabled = false;
        sendMagicLinkBtn.textContent = 'Send Magic Link';
        alert('Failed to send magic link. Please try again.');
      }
    });

    // Sign out handler
    signOutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
    });

    // Auth state listener
    supabase.auth.onAuthStateChange((event, session) => {
      if (session) {
        currentUser = session.user;
        showForm();
      } else {
        currentUser = null;
        showAuth();
      }
    });

    // Image upload handler
    imageInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Show upload status
      uploadStatus.style.display = 'block';
      uploadStatus.textContent = 'Uploading image...';

      try {
        // Create form data for Cloudinary
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', 'blinkshop');

        // Upload to Cloudinary
        const response = await fetch('https://api.cloudinary.com/v1_1/dujy3bj9z/image/upload', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Upload failed');
        }

        const result = await response.json();
        uploadedImageUrl = result.secure_url;

        // Show preview
        imagePreview.src = uploadedImageUrl;
        uploadStatus.textContent = 'Image uploaded successfully!';
        setTimeout(() => {
          uploadStatus.style.display = 'none';
        }, 2000);

      } catch (error) {
        console.error('Upload error:', error);
        uploadStatus.textContent = 'Upload failed. Please try again.';
        uploadStatus.style.color = '#dc2626';
      }
    });

    // Theme handling
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      themeLabels.forEach(label => {
        label.toggleAttribute('data-active', label.getAttribute('data-theme-value') === theme);
      });
      currentTheme = theme;
    }

    themeLabels.forEach(label => {
      label.addEventListener('click', () => {
        setTheme(label.getAttribute('data-theme-value'));
      });
    });

    // Story counter
    storyInput.addEventListener('input', () => {
      storyCount.textContent = `${storyInput.value.length} / 300`;
    });

    // Load ?img= parameter for image preview
    const params = new URLSearchParams(window.location.search);
    const imgParam = params.get("img");
    if (imgParam) {
      imagePreview.src = decodeURIComponent(imgParam);
      uploadedImageUrl = decodeURIComponent(imgParam);
    }

    // Initialize theme
    setTheme(currentTheme);

    // Form submission handler
    publishBtn.addEventListener('click', async () => {
      if (!currentUser) {
        alert('Please sign in to publish your drop');
        return;
      }

      const title = document.getElementById('titleInput')?.value.trim();
      const qty = parseInt(document.getElementById('qtyInput')?.value) || 1;
      const price = parseFloat(document.getElementById('priceInput')?.value) || 0;
      const story = document.getElementById('storyInput')?.value.trim();
      const shipping_info = document.getElementById('shippingInput')?.value;
      const returns_info = document.getElementById('returnsInput')?.value;
      const theme = document.documentElement.getAttribute('data-theme') || 'minimal';
      const image_url = uploadedImageUrl || imagePreview.src;

      if (!title || !price || !image_url) {
        alert('Missing required fields: title, price, or image.');
        return;
      }

      if (price < 1) {
        alert('Price must be at least $1.00');
        return;
      }

      const dropData = {
        title,
        quantity: qty,
        price_cents: Math.round(price * 100),
        story,
        image_url,
        shipping_info,
        returns_info,
        theme
      };

      publishBtn.disabled = true;
      publishBtn.textContent = 'Publishing...';

      try {
        // Get auth token
        const { data: { session } } = await supabase.auth.getSession();
        
        const res = await fetch('/.netlify/functions/create-drop', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session?.access_token}`
          },
          body: JSON.stringify(dropData)
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Unknown error');
        
        console.log('✅ Drop published:', result.data);
        alert(`Drop published! View it at: ${result.checkout_url}`);
        
      } catch (err) {
        console.error('Failed to publish drop:', err);
        alert('Something went wrong while publishing your drop.');
      } finally {
        publishBtn.disabled = false;
        publishBtn.textContent = 'Publish';
      }
    });
  </script>
</body>
</html>